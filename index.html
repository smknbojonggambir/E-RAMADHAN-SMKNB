<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>E-RAMADHAN SMKNB 2026</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
  :root {
    --primary: #2c5364;
    --accent: #203a43;
    --bg: #0f2027;
  }
  body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: linear-gradient(135deg, var(--bg), var(--accent), var(--primary));
    color: white;
    margin: 0;
    padding: 20px;
    min-height: 100vh;
  }
  h2 { margin-bottom: 20px; text-shadow: 2px 2px 4px rgba(0,0,0,0.5); }
  
  /* Kartu Container */
  .card {
    background: rgba(255, 255, 255, 0.95);
    color: #333;
    padding: 25px;
    border-radius: 20px;
    margin: 10px auto;
    max-width: 400px;
    box-shadow: 0 10px 25px rgba(0,0,0,0.3);
  }
  
  /* Form Elements */
  label { display: block; text-align: left; font-weight: bold; margin-top: 10px; font-size: 0.9em; }
  select, input, button {
    width: 100%;
    padding: 12px;
    margin: 5px 0 15px 0;
    border: 1px solid #ddd;
    border-radius: 8px;
    box-sizing: border-box;
    font-size: 16px;
  }
  
  /* Button Styling */
  button {
    background: var(--primary);
    color: white;
    border: none;
    font-weight: bold;
    cursor: pointer;
    transition: transform 0.1s, background 0.3s;
  }
  button:active { transform: scale(0.98); }
  button:disabled { background: #999; cursor: not-allowed; }
  
  .preview {
    width: 100%;
    border-radius: 10px;
    margin-top: 10px;
    border: 2px dashed #ccc;
    display: none;
  }

  /* Loading Spinner Overlay */
  #loadingOverlay {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.7);
    display: none;
    justify-content: center; align-items: center; flex-direction: column;
    z-index: 999;
  }
  .spinner {
    width: 50px; height: 50px;
    border: 5px solid #f3f3f3; border-top: 5px solid #3498db;
    border-radius: 50%;
    animation: spin 1s linear infinite;
  }
  @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
  
  .hidden { display: none; }
</style>
</head>

<body>

<h2>üåô E-RAMADHAN SMKNB 2026</h2>

<div id="loadingOverlay">
  <div class="spinner"></div>
  <p style="color:white; margin-top:15px;">Memproses data...</p>
</div>

<div class="card" id="loginBox">
  <h3>üîê Login Siswa/Guru</h3>
  <input id="u" placeholder="Username" type="text">
  <input id="p" type="password" placeholder="Password">
  <button onclick="handleLogin()">Masuk Aplikasi</button>
</div>

<div id="app" class="hidden">
  
  <div class="card">
    <div style="display:flex; justify-content:space-between; align-items:center;">
      <h3 id="welcomeText">Halo!</h3>
      <button onclick="logout()" style="width:auto; padding:5px 10px; background:#c0392b; font-size:12px;">Logout</button>
    </div>
    <hr>
    
    <label>Apakah Berpuasa?</label>
    <select id="puasa">
      <option value="Ya">Ya, Puasa</option>
      <option value="Tidak">Tidak / Berhalangan</option>
    </select>

    <label>Shalat 5 Waktu</label>
    <select id="shalat">
      <option value="Lengkap">Lengkap 5 Waktu</option>
      <option value="Tidak Lengkap">Bolong-bolong</option>
    </select>

    <label>Shalat Tarawih</label>
    <select id="tarawih">
      <option value="Ya">Ya, Tarawih</option>
      <option value="Tidak">Tidak</option>
    </select>

    <label>Tadarus Al-Quran</label>
    <select id="tadarus">
      <option value="Ya">Ya</option>
      <option value="Tidak">Tidak</option>
    </select>
    
    <label>Sedekah / Infaq</label>
    <select id="sedekah">
      <option value="Ya">Ya</option>
      <option value="Tidak">Tidak</option>
    </select>

    <label>üì∏ Foto Dokumentasi (Wajib)</label>
    <input type="file" id="foto" accept="image/*" capture="environment" onchange="processImage()">
    <img id="preview" class="preview">
    
    <button onclick="kirimLaporan()" id="btnSimpan" style="margin-top:20px;">‚úÖ KIRIIM LAPORAN</button>
  </div>

  <div class="card hidden" id="dashboard">
    <h3>üèÜ Ranking Keaktifan</h3>
    <canvas id="chart"></canvas>
    <button onclick="loadChart()" style="margin-top:10px; background:#e67e22;">üîÑ Refresh Data</button>
  </div>

</div>

<script>
// ================= CONFIGURATION =================
// PASTE URL WEB APP APPS SCRIPT DI SINI:
const API_URL = "https://script.google.com/macros/s/AKfycbxIdKgmLx3xNjiAW_17rB4yW3wqHMhwJUQ0-v-W6X3Np_f4CI6GVtPTlFGTKg9cg_d0/exec"; 

let currentUser = null;
let compressedImageBase64 = "";

// ================= LOGIN FUNCTION =================
async function handleLogin(){
  const u = document.getElementById('u').value.trim();
  const p = document.getElementById('p').value.trim();
  
  if(!u || !p) return alert("Username dan Password harus diisi!");
  
  loading(true);
  try {
    const res = await fetch(API_URL, {
      method: "POST",
      body: JSON.stringify({ action: "login", username: u, password: p })
    });
    const data = await res.json();
    
    if(data.status){
      currentUser = data;
      document.getElementById('welcomeText').innerText = "Halo, " + data.nama;
      document.getElementById('loginBox').classList.add('hidden');
      document.getElementById('app').classList.remove('hidden');
      
      // Jika Admin, tampilkan chart
      if(data.role.toLowerCase() === 'admin'){
        document.getElementById('dashboard').classList.remove('hidden');
        loadChart();
      }
    } else {
      alert("Login Gagal: " + (data.message || "Cek username/password"));
    }
  } catch (err) {
    alert("Gagal terhubung ke server. Cek koneksi internet.");
    console.error(err);
  }
  loading(false);
}

// ================= IMAGE PROCESSING (RESIZE) =================
function processImage(){
  const fileInput = document.getElementById('foto');
  const preview = document.getElementById('preview');
  
  if (fileInput.files && fileInput.files[0]) {
    const file = fileInput.files[0];
    const reader = new FileReader();
    
    reader.onload = function(e) {
      const img = new Image();
      img.src = e.target.result;
      
      img.onload = function() {
        // Resize logic using Canvas
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        
        // Max width 800px (agar ringan upload ke Google)
        const maxWidth = 800;
        let width = img.width;
        let height = img.height;
        
        if (width > maxWidth) {
          height *= maxWidth / width;
          width = maxWidth;
        }
        
        canvas.width = width;
        canvas.height = height;
        ctx.drawImage(img, 0, 0, width, height);
        
        // Simpan hasil kompresi ke variabel global
        compressedImageBase64 = canvas.toDataURL('image/jpeg', 0.7); // Quality 0.7
        
        // Tampilkan preview
        preview.src = compressedImageBase64;
        preview.style.display = "block";
      }
    }
    reader.readAsDataURL(file);
  }
}

// ================= SUBMIT DATA =================
async function kirimLaporan(){
  if(!compressedImageBase64) {
    return alert("Harap ambil foto dokumentasi terlebih dahulu!");
  }

  const btn = document.getElementById('btnSimpan');
  loading(true);
  
  // Ambil GPS (Optional, don't block if fails)
  let lat = "", long = "";
  try {
    const pos = await getPosition();
    lat = pos.coords.latitude;
    long = pos.coords.longitude;
  } catch(e) {
    console.log("GPS tidak aktif/ditolak");
  }

  const payload = {
    action: "simpan",
    username: currentUser.username,
    nama: currentUser.nama,
    kelas: currentUser.kelas,
    puasa: document.getElementById('puasa').value,
    shalat: document.getElementById('shalat').value,
    tarawih: document.getElementById('tarawih').value,
    tadarus: document.getElementById('tadarus').value,
    sedekah: document.getElementById('sedekah').value,
    foto: compressedImageBase64,
    lat: lat,
    long: long
  };

  try {
    const res = await fetch(API_URL, {
      method: "POST",
      body: JSON.stringify(payload)
    });
    const result = await res.json();
    
    if(result.status){
      alert("‚úÖ Laporan Berhasil Disimpan! Poin bertambah.");
      resetForm();
      if(currentUser.role === 'admin') loadChart();
    } else {
      alert("Gagal menyimpan: " + result.message);
    }
  } catch(err) {
    alert("Terjadi kesalahan jaringan.");
  }
  loading(false);
}

// ================= CHART ADMIN =================
let myChart = null;

async function loadChart(){
  try {
    const res = await fetch(API_URL, {
      method: "POST",
      body: JSON.stringify({ action: "ranking" })
    });
    const data = await res.json();
    
    const ctx = document.getElementById('chart').getContext('2d');
    
    if(myChart) myChart.destroy();
    
    myChart = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: Object.keys(data),
        datasets: [{
          label: 'Total Poin',
          data: Object.values(data),
          backgroundColor: 'rgba(54, 162, 235, 0.6)',
          borderColor: 'rgba(54, 162, 235, 1)',
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        scales: { y: { beginAtZero: true } }
      }
    });
  } catch(e) { console.error("Gagal load chart"); }
}

// ================= UTILS =================
function getPosition() {
  return new Promise((resolve, reject) => {
    if(!navigator.geolocation) reject();
    navigator.geolocation.getCurrentPosition(resolve, reject, {timeout: 5000});
  });
}

function resetForm(){
  document.getElementById('foto').value = "";
  document.getElementById('preview').style.display = "none";
  compressedImageBase64 = "";
}

function loading(isLoading){
  const overlay = document.getElementById('loadingOverlay');
  overlay.style.display = isLoading ? 'flex' : 'none';
}

function logout(){
  location.reload();
}
</script>

</body>
</html>
