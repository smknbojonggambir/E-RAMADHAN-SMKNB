<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="theme-color" content="#059669">
<title>E-RAMADHAN SMKNB</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">
<style>
  :root {
    --primary: #059669; /* Emerald 600 */
    --primary-dark: #047857;
    --accent: #d97706; /* Amber 600 */
    --bg: #f8fafc;
    --card: #ffffff;
    --text: #334155;
    --border: #e2e8f0;
    --radius: 16px;
    --shadow: 0 4px 6px -1px rgba(0,0,0,0.05), 0 2px 4px -1px rgba(0,0,0,0.03);
  }

  * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
  body { font-family: 'Poppins', sans-serif; background: var(--bg); margin: 0; padding: 0; color: var(--text); padding-bottom: 70px; }

  /* HEADER MODERN */
  .header {
    background: linear-gradient(160deg, var(--primary), var(--primary-dark));
    padding: 30px 20px 50px; text-align: center; color: white;
    border-radius: 0 0 30px 30px; position: relative;
    box-shadow: 0 10px 25px rgba(5, 150, 105, 0.2);
  }
  .header h2 { margin: 0; font-size: 1.5rem; letter-spacing: 1px; }
  .header p { margin: 5px 0 0; opacity: 0.9; font-size: 0.85rem; font-weight: 300; }
  .logo { 
    width: 80px; height: 80px; background: white; border-radius: 50%; 
    padding: 4px; margin-bottom: 10px; object-fit: contain;
    box-shadow: 0 4px 10px rgba(0,0,0,0.1);
  }

  /* CONTAINER & CARD */
  .container { max-width: 500px; margin: -40px auto 0; padding: 0 20px; position: relative; z-index: 10; }
  .card {
    background: var(--card); padding: 20px; border-radius: var(--radius);
    box-shadow: var(--shadow); margin-bottom: 15px; border: 1px solid white;
    animation: slideUp 0.4s ease-out;
  }

  /* FORMS & INPUTS */
  label { font-size: 0.8rem; font-weight: 600; color: var(--primary); margin-bottom: 6px; display: block; text-transform: uppercase; letter-spacing: 0.5px; }
  select, input, button {
    width: 100%; padding: 14px; border-radius: 12px; border: 1px solid var(--border);
    font-family: inherit; font-size: 0.95rem; background: #f8fafc; outline: none;
    transition: all 0.2s; margin-bottom: 12px;
  }
  select:focus, input:focus { border-color: var(--primary); background: #fff; box-shadow: 0 0 0 3px rgba(5, 150, 105, 0.1); }
  
  button {
    background: var(--primary); color: white; border: none; font-weight: 600;
    cursor: pointer; box-shadow: 0 4px 12px rgba(5, 150, 105, 0.25);
  }
  button:active { transform: scale(0.97); }
  button:disabled { background: #cbd5e1; box-shadow: none; cursor: default; }
  
  .btn-outline { background: transparent; border: 1px solid var(--border); color: #64748b; box-shadow: none; }
  .btn-outline:hover { background: #f1f5f9; }

  /* GROUPING */
  .act-group {
    background: #fff; border: 1px solid var(--border); padding: 15px;
    border-radius: 12px; margin-bottom: 12px; position: relative; overflow: hidden;
  }
  .act-group::before {
    content: ''; position: absolute; left: 0; top: 0; bottom: 0; width: 4px;
    background: var(--accent);
  }
  .act-group b { display: block; margin-bottom: 8px; font-size: 0.95rem; color: #1e293b; }

  /* GPS & UPLOAD */
  .gps-box {
    display: flex; align-items: center; gap: 10px; padding: 12px;
    background: #ecfdf5; border: 1px solid #a7f3d0; border-radius: 10px;
    color: #065f46; font-size: 0.85rem; font-weight: 500; margin-bottom: 15px;
  }
  .gps-error { background: #fef2f2; border-color: #fecaca; color: #991b1b; }
  
  input[type="file"] { padding: 10px; background: white; border: 2px dashed #cbd5e1; text-align: center; }

  /* ADMIN LIST */
  .row-data {
    display: flex; justify-content: space-between; align-items: center;
    padding: 12px 0; border-bottom: 1px solid #f1f5f9; cursor: pointer;
  }
  .row-data:last-child { border-bottom: none; }
  .avatar {
    width: 35px; height: 35px; background: #e2e8f0; border-radius: 50%;
    display: flex; justify-content: center; align-items: center; font-size: 1.2rem; margin-right: 10px;
  }

  /* FOOTER */
  .footer-dev {
    text-align: center; font-size: 0.75rem; color: #94a3b8; margin-top: 30px;
    padding-top: 15px; border-top: 1px solid #f1f5f9;
  }
  /* Style khusus untuk link Kang Ruli */
  .footer-dev a { 
    color: var(--primary); 
    text-decoration: none; 
    font-weight: 700; 
    transition: color 0.2s;
  }
  .footer-dev a:hover { color: var(--accent); text-decoration: underline; }

  /* MODAL */
  .modal {
    position: fixed; inset: 0; background: rgba(0,0,0,0.5); backdrop-filter: blur(3px);
    z-index: 100; display: none; align-items: center; justify-content: center; padding: 20px;
  }
  .modal-content {
    background: white; width: 100%; max-width: 400px; padding: 25px;
    border-radius: 20px; max-height: 85vh; overflow-y: auto;
    animation: popIn 0.3s cubic-bezier(0.18, 0.89, 0.32, 1.28);
  }

  /* UTILS */
  .hidden { display: none; }
  @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
  @keyframes popIn { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }
</style>
</head>
<body>

<div class="header">
  <img src="https://raw.githubusercontent.com/smknbojonggambir/E-RAMADHAN-SMKNB/main/LOGO.png" class="logo" alt="Logo">
  <h2>E-RAMADHAN SMKNB</h2>
  <p>Yuk, Catat Amal Ibadahmu Hari Ini!" "Sudah berbuat baik apa hari ini?" "Isi jurnal ibadahmu dengan jujur ya!</p>
</div>

<div class="container">
  
  <div id="panel-siswa">
    <div class="card">
      <h3 style="margin-top:0; text-align:center; color:var(--primary-dark);">üìù Identitas Siswa</h3>
      <label>Kelas</label>
      <select id="pKelas" onchange="loadNama()"><option>Memuat Data...</option></select>
      
      <div id="areaNama" class="hidden">
        <label>Nama Lengkap</label>
        <select id="pNama"><option value="">-- Pilih Nama --</option></select>
        <button onclick="bukaForm()" style="margin-top:15px">LANJUT ISI LAPORAN</button>
      </div>
    </div>

    <div id="formIbadah" class="hidden">
      <div class="card">
        <h3 style="margin-top:0; color:var(--primary);">üìç Lokasi & Aktivitas</h3>
        
        <div id="gps-box" class="gps-box">
          <span style="font-size:1.2rem">üîÑ</span>
          <span id="gps-text">Mencari lokasi kamu...</span>
        </div>

        <div class="act-group">
          <b>1. Puasa Hari Ini?</b>
          <select id="puasa">
            <option value="Ya">‚úÖ Ya, Full</option>
            <option value="Setengah">üåó Setengah Hari</option>
            <option value="Tidak">‚ùå Tidak Puasa</option>
          </select>
          <input id="k_puasa" placeholder="Catatan (Opsional)">
        </div>

        <div class="act-group">
          <b>2. Shalat Wajib?</b>
          <select id="shalat">
            <option value="Ya">‚úÖ Lengkap 5 Waktu</option>
            <option value="Bolong">‚ö†Ô∏è Ada yang bolong</option>
            <option value="Tidak">‚ùå Tidak Shalat</option>
          </select>
          <input id="k_shalat" placeholder="Catatan (Opsional)">
        </div>

        <div class="act-group">
          <b>3. Shalat Tarawih?</b>
          <select id="tarawih"><option value="Ya">‚úÖ Ya</option><option value="Tidak">‚ùå Tidak</option></select>
          <input id="k_tarawih" placeholder="Catatan (Opsional)">
        </div>

        <div class="act-group">
          <b>4. Tadarus Al-Qur'an?</b>
          <select id="tadarus"><option value="Ya">‚úÖ Ya</option><option value="Tidak">‚ùå Tidak</option></select>
          <input id="k_tadarus" placeholder="Juz / Surat apa?">
        </div>

        <div class="act-group">
          <b>5. Infaq / Sedekah?</b>
          <select id="sedekah"><option value="Ya">‚úÖ Ya</option><option value="Tidak">‚ùå Tidak</option></select>
          <input id="k_sedekah" placeholder="Catatan">
        </div>

        <div class="act-group" style="border-left-color: var(--primary);">
          <b>üì∏ Foto Bukti (Selfie/Kegiatan)</b>
          <input type="file" id="foto" accept="image/*" capture="environment">
        </div>

        <button onclick="kirim()" id="btnKirim" style="font-size:1.1rem; padding:16px;">üöÄ KIRIM LAPORAN</button>
      </div>
    </div>
  </div>

  <div id="panel-login-admin" class="hidden">
    <div class="card" style="text-align:center;">
      <h3 style="color:var(--primary)">üîê Login Guru</h3>
      <input type="password" id="adminPass" placeholder="Masukkan Password">
      <button onclick="loginAdmin()">MASUK</button>
      <button onclick="modeSiswa()" class="btn-outline">Kembali</button>
    </div>
  </div>

  <div id="dashboard-admin" class="hidden">
    <div class="card">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
        <h3 style="margin:0;">üë®‚Äçüè´ Monitor</h3>
        <button onclick="location.reload()" style="width:auto; padding:5px 12px; font-size:0.8rem; background:#ef4444;">Logout</button>
      </div>
      
      <div style="display:flex; gap:10px;">
        <input type="date" id="admDate" onchange="loadRekap()" style="margin:0;">
        <select id="admKelas" onchange="loadRekap()" style="margin:0;">
          <option value="Semua">Semua Kelas</option>
        </select>
      </div>
      <div style="margin-top:10px; font-size:0.9rem; color:#64748b; text-align:center;">
        Total Lapor: <b id="totalLapor" style="color:var(--primary)">0</b> Siswa
      </div>
    </div>

    <div class="card" style="padding:10px;">
      <div id="list-rekap">
        <p style="text-align:center; padding:20px; color:#94a3b8;">Pilih tanggal untuk melihat data.</p>
      </div>
    </div>
  </div>

  <div class="footer-dev">
    <span onclick="modeAdmin()" style="cursor:pointer; display:block; margin-bottom:10px;">Login Admin</span>
    Developer Program <a href="https://www.kangruli.web.id" target="_blank">Kang Ruli</a>
  </div>

</div>

<div id="modalDetail" class="modal">
  <div class="modal-content">
    <div style="text-align:center; margin-bottom:15px;">
      <h3 id="mNama" style="margin:0; color:var(--primary)">Nama Siswa</h3>
      <span id="mKelas" style="background:#f1f5f9; padding:2px 10px; border-radius:10px; font-size:0.8rem; color:#64748b;">Kelas</span>
    </div>
    <div id="mBody" style="background:#f8fafc; padding:15px; border-radius:12px; border:1px solid #e2e8f0; font-size:0.9rem;"></div>
    
    <div style="display:flex; gap:10px; margin-top:15px;">
      <a id="mFoto" href="#" target="_blank" style="flex:1; text-align:center; padding:10px; background:var(--accent); color:white; text-decoration:none; border-radius:10px; font-size:0.9rem;">üì∑ Foto</a>
      <a id="mMap" href="#" target="_blank" style="flex:1; text-align:center; padding:10px; background:#3b82f6; color:white; text-decoration:none; border-radius:10px; font-size:0.9rem;">üó∫Ô∏è Peta</a>
    </div>
    <button onclick="document.getElementById('modalDetail').style.display='none'" class="btn-outline" style="margin-top:10px;">Tutup</button>
  </div>
</div>

<script>
const API = "https://script.google.com/macros/s/AKfycbzRDqVx19H6G0CWAbncInK0C-Yb_X9CwGoaRBwASjiBvhxqmYoCPkAlerpvO2XHoEjwEw/exec";
let DATA_SISWA = {}, USER_LAT = '', USER_LONG = '';

window.onload = function() {
  document.getElementById('admDate').valueAsDate = new Date();
  fetch(API, {method: "POST", body: JSON.stringify({action: "get_siswa"})})
  .then(r=>r.json()).then(res => {
    if(res.status) {
      DATA_SISWA = res.data;
      const s = document.getElementById('pKelas'), sAdm = document.getElementById('admKelas');
      s.innerHTML = '<option value="">-- Pilih Kelas --</option>';
      Object.keys(DATA_SISWA).sort().forEach(k => {
        s.innerHTML += `<option value="${k}">${k}</option>`;
        sAdm.innerHTML += `<option value="${k}">${k}</option>`;
      });
    }
  });
}

function modeAdmin() {
  document.getElementById('panel-siswa').classList.add('hidden');
  document.getElementById('panel-login-admin').classList.remove('hidden');
  window.scrollTo(0,0);
}
function modeSiswa() {
  document.getElementById('panel-login-admin').classList.add('hidden');
  document.getElementById('panel-siswa').classList.remove('hidden');
  window.scrollTo(0,0);
}

function loadNama() {
  const k = document.getElementById('pKelas').value;
  const n = document.getElementById('pNama');
  if(k && DATA_SISWA[k]) {
    n.innerHTML = '<option value="">-- Pilih Nama --</option>';
    DATA_SISWA[k].sort((a,b)=>a.nama.localeCompare(b.nama)).forEach(x => {
      n.innerHTML += `<option value="${x.user}" data-n="${x.nama}">${x.nama}</option>`;
    });
    document.getElementById('areaNama').classList.remove('hidden');
  }
}

function bukaForm(){
  const f = document.getElementById('formIbadah');
  f.classList.remove('hidden');
  f.scrollIntoView({behavior: "smooth"});
  cariLokasi();
}

function cariLokasi() {
  const box = document.getElementById('gps-box'), txt = document.getElementById('gps-text');
  if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(
      (pos) => {
        USER_LAT = pos.coords.latitude; USER_LONG = pos.coords.longitude;
        box.style.background = "#ecfdf5"; box.style.borderColor="#6ee7b7"; box.style.color="#065f46";
        txt.innerHTML = "Lokasi Terkunci: <br><small>"+USER_LAT.toFixed(5)+", "+USER_LONG.toFixed(5)+"</small>";
      },
      (err) => {
        box.className = "gps-box gps-error"; txt.innerText = "Gagal Deteksi Lokasi. Aktifkan GPS!";
        USER_LAT = "Error"; USER_LONG = "Error";
      }, { timeout: 10000, enableHighAccuracy: true }
    );
  }
}

async function kirim() {
  const f = document.getElementById('foto');
  if(!document.getElementById('pNama').value) return alert("Pilih Nama dulu!");
  if(f.files.length === 0) return alert("Wajib lampirkan Foto!");
  
  if(!confirm("Kirim Laporan sekarang?")) return;
  const btn = document.getElementById('btnKirim');
  const txt = btn.innerText; btn.innerText = "Mengirim..."; btn.disabled = true;

  const r = new FileReader();
  r.readAsDataURL(f.files[0]);
  r.onload = async function() {
    const d = {
      action:'simpan',
      username: document.getElementById('pNama').value,
      nama: document.querySelector('#pNama option:checked').getAttribute('data-n'),
      kelas: document.getElementById('pKelas').value,
      foto: r.result, lat: USER_LAT, long: USER_LONG,
      puasa: document.getElementById('puasa').value, ket_puasa: document.getElementById('k_puasa').value,
      shalat: document.getElementById('shalat').value, ket_shalat: document.getElementById('k_shalat').value,
      tarawih: document.getElementById('tarawih').value, ket_tarawih: document.getElementById('k_tarawih').value,
      tadarus: document.getElementById('tadarus').value, ket_tadarus: document.getElementById('k_tadarus').value,
      sedekah: document.getElementById('sedekah').value, ket_sedekah: document.getElementById('k_sedekah').value,
    };
    try {
      const req = await fetch(API, {method:'POST', body:JSON.stringify(d)});
      const res = await req.json();
      if(res.status) { alert("Berhasil! Poin: "+res.poin); location.reload(); }
      else throw new Error();
    } catch (e) { alert("Gagal Kirim. Coba lagi."); btn.disabled=false; btn.innerText=txt; }
  }
}

async function loginAdmin() {
  const p = document.getElementById('adminPass').value;
  const btn = document.querySelector('#panel-login-admin button');
  btn.innerText = "Cek..."; btn.disabled=true;
  try {
    const r = await fetch(API, {method:'POST', body:JSON.stringify({action:'login_admin', pass:p})});
    const res = await r.json();
    if(res.status) {
      document.getElementById('panel-login-admin').classList.add('hidden');
      document.getElementById('dashboard-admin').classList.remove('hidden');
      loadRekap();
    } else { alert("Password Salah!"); }
  } catch(e){ alert("Error Koneksi"); }
  btn.innerText = "MASUK"; btn.disabled=false;
}

async function loadRekap() {
  const tgl = document.getElementById('admDate').value;
  const kls = document.getElementById('admKelas').value;
  const list = document.getElementById('list-rekap');
  list.innerHTML = '<div style="text-align:center; padding:20px; color:#64748b;">‚è≥ Memuat data...</div>';
  
  try {
    const r = await fetch(API, {method:'POST', body:JSON.stringify({action:'get_rekap', tanggal:tgl, kelas:kls})});
    const res = await r.json();
    list.innerHTML = ''; document.getElementById('totalLapor').innerText = res.data.length;
    
    if(res.data.length === 0) { list.innerHTML = '<div style="text-align:center; padding:30px; color:#94a3b8;">Kosong.</div>'; return; }
    
    res.data.forEach(d => {
      const raw = JSON.stringify(d).replace(/"/g, '"');
      list.innerHTML += `
        <div class="row-data" onclick='bukaDetail(${JSON.stringify(raw)})'>
          <div style="display:flex; align-items:center;">
            <div class="avatar">${d.foto.length>5 ? 'üì∑' : 'üë§'}</div>
            <div>
              <div style="font-weight:600; font-size:0.95rem;">${d.nama}</div>
              <div style="font-size:0.75rem; color:#64748b;">${d.kelas} ‚Ä¢ ${d.waktu.split(' ')[1]}</div>
            </div>
          </div>
          <div style="font-weight:bold; color:var(--primary);">${d.poin} Poin</div>
        </div>`;
    });
  } catch(e) { list.innerHTML = 'Gagal memuat.'; }
}

function bukaDetail(jsonStr) {
  const obj = JSON.parse(jsonStr), d = obj.detail;
  document.getElementById('mNama').innerText = obj.nama;
  document.getElementById('mKelas').innerText = obj.kelas;
  document.getElementById('mBody').innerHTML = `
    <b>Puasa:</b> ${d[4]} <i style='color:#666'>(${d[5]||'-'})</i><br>
    <b>Shalat:</b> ${d[6]} <i style='color:#666'>(${d[7]||'-'})</i><br>
    <b>Tarawih:</b> ${d[8]} <i style='color:#666'>(${d[9]||'-'})</i><br>
    <b>Tadarus:</b> ${d[10]} <i style='color:#666'>(${d[11]||'-'})</i><br>
    <b>Sedekah:</b> ${d[12]} <i style='color:#666'>(${d[13]||'-'})</i>`;
    
  const btnFoto = document.getElementById('mFoto'), btnMap = document.getElementById('mMap');
  btnFoto.style.display = (obj.foto && obj.foto.length > 5) ? 'block' : 'none'; btnFoto.href = obj.foto;
  
  if(obj.lat && obj.long && obj.lat != '-' && obj.lat != 'Error') {
    btnMap.style.display = 'block';
    // Link map standar
    btnMap.href = 'https://www.google.com/maps?q=' + obj.lat + ',' + obj.long;
  } else { btnMap.style.display = 'none'; }
  
  document.getElementById('modalDetail').style.display = 'flex';
}
</script>
</body>
</html>
