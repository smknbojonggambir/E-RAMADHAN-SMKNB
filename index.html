<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>E-RAMADHAN SMKNB</title>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #4f46e5;
            --secondary: #0ea5e9;
            --bg: #f8fafc;
            --surface: #ffffff;
            --text-main: #0f172a;
            --text-muted: #64748b;
            --border: #e2e8f0;
            --radius: 16px;
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: 'Plus Jakarta Sans', sans-serif; background: var(--bg); color: var(--text-main); margin: 0; padding-bottom: 100px; }
        
        .header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            padding: 30px 20px 60px 20px;
            border-radius: 0 0 30px 30px;
            color: white; text-align: center;
            margin-bottom: -40px; box-shadow: 0 10px 20px rgba(79, 70, 229, 0.2);
        }
        .header h1 { margin: 0; font-size: 24px; font-weight: 800; }
        
        .container { max-width: 600px; margin: 0 auto; padding: 0 20px; position: relative; z-index: 10; }
        
        .card {
            background: var(--surface); padding: 24px; border-radius: var(--radius);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); margin-bottom: 20px;
            border: 1px solid white;
        }
        
        h2 { margin: 0 0 20px 0; font-size: 16px; color: var(--primary); text-transform: uppercase; letter-spacing: 1px; font-weight: 700; display: flex; align-items: center; gap: 10px; }
        h2::before { content: ''; display: block; width: 4px; height: 16px; background: var(--secondary); border-radius: 2px; }

        .form-group { margin-bottom: 16px; }
        label { display: block; font-size: 12px; font-weight: 700; margin-bottom: 8px; color: var(--text-muted); text-transform: uppercase; }
        
        select, input[type="text"] {
            width: 100%; padding: 14px; border-radius: 12px; border: 2px solid var(--border);
            font-size: 14px; font-weight: 600; color: var(--text-main); background-color: #f8fafc;
        }
        select:focus, input:focus { border-color: var(--primary); outline: none; background: #fff; }

        /* Readonly input for Supervisor */
        .input-read { background-color: #e0e7ff !important; color: var(--primary) !important; border-color: transparent !important; }

        .btn-primary {
            width: 100%; padding: 16px; border-radius: 12px; background: var(--primary);
            color: white; border: none; font-weight: 700; font-size: 15px; cursor: pointer;
            box-shadow: 0 4px 12px rgba(79, 70, 229, 0.3); transition: 0.2s;
        }
        .btn-primary:active { transform: scale(0.98); }

        /* Nav */
        .bottom-nav {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
            width: 90%; max-width: 400px; background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px); border-radius: 25px; display: flex; padding: 5px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.15); z-index: 100;
        }
        .nav-item { flex: 1; padding: 12px; text-align: center; font-size: 13px; font-weight: 700; color: var(--text-muted); cursor: pointer; border-radius: 20px; transition: 0.3s; }
        .nav-item.active { background: var(--primary); color: white; }

        .hidden { display: none !important; }
        .loader { position: fixed; inset: 0; background: rgba(255,255,255,0.9); z-index: 999; display: flex; align-items: center; justify-content: center; flex-direction: column;}
        .spinner { width: 40px; height: 40px; border: 4px solid #e2e8f0; border-top-color: var(--primary); border-radius: 50%; animation: spin 0.8s infinite; margin-bottom: 10px;}
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <div id="loader" class="loader">
        <div class="spinner"></div>
        <span id="load-text" style="font-weight:600">Menyiapkan Database...</span>
    </div>

    <div class="header">
        <h1>Laporan Ramadhan</h1>
        <p>SMK Negeri Bojonggambir</p>
    </div>

    <div id="page-siswa" class="container">
        <div style="height: 30px;"></div> 
        
        <div class="card">
            <h2>Identitas Peserta</h2>
            
            <div class="form-group">
                <label>PILIH KELOMPOK</label>
                <select id="kelompok" onchange="loadPembimbingAndSiswa()">
                    <option value="">-- Sedang memuat data... --</option>
                </select>
            </div>

            <div class="form-group">
                <label>PEMBIMBING</label>
                <input type="text" id="pembimbing" class="input-read" value="-" readonly>
            </div>
            
            <div class="form-group">
                <label>NAMA SISWA</label>
                <select id="nama" disabled>
                    <option value="">Pilih Kelompok dulu...</option>
                </select>
            </div>
        </div>
        
        <div class="card">
            <h2>Laporan Ibadah</h2>
            <div class="form-group"><label>Puasa?</label>
                <select id="puasa"><option value="Ya">Ya</option><option value="Tidak">Tidak</option></select>
            </div>
            <div class="form-group"><label>Shalat Wajib 5 Waktu?</label>
                <select id="shalat"><option value="Ya">Ya</option><option value="Tidak">Tidak</option></select>
            </div>
            <div class="form-group"><label>Shalat Tarawih?</label>
                <select id="tarawih"><option value="Ya">Ya</option><option value="Tidak">Tidak</option></select>
            </div>
            <div class="form-group"><label>Tadarus Al-Quran?</label>
                <select id="tadarus"><option value="Ya">Ya</option><option value="Tidak">Tidak</option></select>
            </div>
             <div class="form-group"><label>Sedekah?</label>
                <select id="sedekah"><option value="Ya">Ya</option><option value="Tidak">Tidak</option></select>
            </div>
            
            <input type="hidden" id="ket_puasa" value="-">
            <input type="hidden" id="ket_shalat" value="-">
            <input type="hidden" id="ket_tarawih" value="-">
            <input type="hidden" id="ket_tadarus" value="-">
            <input type="hidden" id="ket_sedekah" value="-">
        </div>

        <button class="btn-primary" onclick="kirimLaporan()">KIRIM LAPORAN</button>
    </div>

    <div id="page-wali" class="container hidden">
        <div style="height: 30px;"></div>
        <div class="card">
            <h2>Panel Pembimbing</h2>
            <p>Fitur rekap data siswa akan tampil di sini.</p>
        </div>
    </div>

    <div class="bottom-nav">
        <div class="nav-item active" onclick="nav('siswa')">SISWA</div>
        <div class="nav-item" onclick="nav('wali')">PEMBIMBING</div>
    </div>

<script>
    // GANTI URL INI DENGAN URL DEPLOYMENT APPS SCRIPT ANDA
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyrQLwLxUTeoRK17qmgc2SGq6kXRu1DA-vuumFvp40wlzK60z31Ngjp3lgN60uBUd_22w/exec"; 

    let DATA_DATABASE = {};

    // Saat halaman dimuat, ambil data dari Spreadsheet
    window.onload = function() {
        fetchDataSiswa();
    };

    function fetchDataSiswa() {
        fetch(SCRIPT_URL, {
            method: 'POST',
            body: JSON.stringify({ action: "get_siswa" })
        })
        .then(res => res.json())
        .then(response => {
            document.getElementById('loader').classList.add('hidden');
            if(response.status) {
                DATA_DATABASE = response.data;
                renderKelompokDropdown();
            } else {
                alert("Gagal memuat data siswa.");
            }
        })
        .catch(err => {
            alert("Koneksi Error: " + err);
            document.getElementById('loader').classList.add('hidden');
        });
    }

    function renderKelompokDropdown() {
        const sel = document.getElementById('kelompok');
        sel.innerHTML = '<option value="">-- Pilih Kelompok --</option>';
        // Ambil daftar nama kelompok (Keys dari object)
        const groups = Object.keys(DATA_DATABASE).sort();
        
        groups.forEach(g => {
            sel.innerHTML += `<option value="${g}">${g}</option>`;
        });
    }

    function loadPembimbingAndSiswa() {
        const kel = document.getElementById('kelompok').value;
        const pem = document.getElementById('pembimbing');
        const nam = document.getElementById('nama');

        if (kel && DATA_DATABASE[kel]) {
            // Set Nama Pembimbing
            pem.value = DATA_DATABASE[kel].pembimbing;
            
            // Populate Dropdown Siswa
            nam.disabled = false;
            nam.innerHTML = '<option value="">-- Pilih Nama Anda --</option>';
            DATA_DATABASE[kel].siswa.sort().forEach(s => {
                nam.innerHTML += `<option value="${s}">${s}</option>`;
            });
        } else {
            pem.value = "-";
            nam.innerHTML = '<option value="">Pilih Kelompok Dulu</option>';
            nam.disabled = true;
        }
    }

    function kirimLaporan() {
        const data = {
            action: "simpan",
            kelompok: document.getElementById('kelompok').value,
            nama: document.getElementById('nama').value,
            puasa: document.getElementById('puasa').value,
            ket_puasa: "-",
            shalat: document.getElementById('shalat').value,
            ket_shalat: "-",
            tarawih: document.getElementById('tarawih').value,
            ket_tarawih: "-",
            tadarus: document.getElementById('tadarus').value,
            ket_tadarus: "-",
            sedekah: document.getElementById('sedekah').value,
            ket_sedekah: "-",
            foto: "", // Tambahkan logika foto jika ada input file
            lat: "", long: ""
        };

        if(!data.kelompok || !data.nama) return alert("Pilih Kelompok dan Nama dulu!");

        document.getElementById('loader').classList.remove('hidden');
        document.getElementById('load-text').innerText = "Mengirim Laporan...";

        fetch(SCRIPT_URL, {
            method: 'POST',
            body: JSON.stringify(data)
        })
        .then(res => res.json())
        .then(res => {
            document.getElementById('loader').classList.add('hidden');
            if(res.status) {
                alert("Alhamdulillah, laporan berhasil disimpan (+"+res.poin+" Poin)");
                location.reload();
            } else {
                alert("Gagal: " + res.message);
            }
        });
    }

    function nav(tab) {
        document.getElementById('page-siswa').classList.toggle('hidden', tab !== 'siswa');
        document.getElementById('page-wali').classList.toggle('hidden', tab !== 'wali');
        
        document.querySelectorAll('.nav-item').forEach((el, idx) => {
            if(tab === 'siswa' && idx === 0) el.classList.add('active');
            else if(tab === 'wali' && idx === 1) el.classList.add('active');
            else el.classList.remove('active');
        });
    }
</script>
</body>
</html>
