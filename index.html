<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Lapor Ibadah</title>
<style>
  body { font-family: sans-serif; background: #f0f2f5; margin: 0; padding: 15px; color: #333; }
  .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); max-width: 500px; margin: 0 auto; }
  h2 { text-align: center; color: #2e7d32; margin-top: 0; }
  
  label { font-weight: bold; font-size: 14px; display: block; margin-top: 15px; margin-bottom: 5px; }
  select, input[type="text"], textarea { width: 100%; padding: 12px; border: 1px solid #ccc; border-radius: 8px; box-sizing: border-box; font-size: 14px; }
  
  /* Group Input Aktivitas */
  .act-group { border: 1px solid #e0e0e0; padding: 10px; border-radius: 8px; margin-top: 10px; background: #fafafa; }
  .act-title { font-weight: bold; color: #1565c0; margin-bottom: 5px; }
  
  button { width: 100%; padding: 15px; background: #2e7d32; color: white; border: none; border-radius: 8px; font-weight: bold; font-size: 16px; margin-top: 20px; cursor: pointer; }
  button:disabled { background: #ccc; }
  
  #loading { display: none; text-align: center; margin-top: 10px; color: #666; }
  .hidden { display: none; }
</style>
</head>
<body>

<div class="card">
  <h2>ðŸ“‹ Lapor Ibadah Harian</h2>
  
  <label>Pilih Kelas:</label>
  <select id="pilihKelas" onchange="loadNama()">
    <option value="">-- Loading Kelas --</option>
  </select>

  <div id="boxNama" class="hidden">
    <label>Pilih Nama Kamu:</label>
    <select id="pilihNama">
      <option value="">-- Pilih Nama --</option>
    </select>
  </div>

  <hr>

  <div id="formIbadah" class="hidden">
    
    <div class="act-group">
      <div class="act-title">1. Puasa Hari Ini?</div>
      <select id="puasa">
        <option value="Ya">Ya, Puasa Penuh</option>
        <option value="Setengah">Setengah Hari</option>
        <option value="Tidak">Tidak / Berhalangan</option>
      </select>
      <input type="text" id="ket_puasa" placeholder="Catatan (Opsional)">
    </div>

    <div class="act-group">
      <div class="act-title">2. Shalat Wajib (5 Waktu)?</div>
      <select id="shalat">
        <option value="Ya">Lengkap 5 Waktu</option>
        <option value="Bolong">Ada yang bolong</option>
        <option value="Tidak">Tidak Shalat</option>
      </select>
      <input type="text" id="ket_shalat" placeholder="Ket: Shalat apa yang bolong?">
    </div>

    <div class="act-group">
      <div class="act-title">3. Shalat Tarawih?</div>
      <select id="tarawih">
        <option value="Ya">Ya</option>
        <option value="Tidak">Tidak</option>
      </select>
      <input type="text" id="ket_tarawih" placeholder="Ket: Di Masjid/Rumah?">
    </div>

    <div class="act-group">
      <div class="act-title">4. Tadarus Al-Quran?</div>
      <select id="tadarus">
        <option value="Ya">Ya</option>
        <option value="Tidak">Tidak</option>
      </select>
      <input type="text" id="ket_tadarus" placeholder="Ket: Surat apa / Juz berapa?">
    </div>

    <div class="act-group">
      <div class="act-title">5. Bersedekah / Infak?</div>
      <select id="sedekah">
        <option value="Ya">Ya</option>
        <option value="Tidak">Tidak</option>
      </select>
      <input type="text" id="ket_sedekah" placeholder="Ket: Bentuk sedekah?">
    </div>

    <label>ðŸ“¸ Foto Dokumentasi (Salah satu kegiatan)</label>
    <input type="file" id="fotoInput" accept="image/*" capture="environment">
    <small style="color:red; display:block; margin-top:5px;">*Foto wajib diisi</small>

    <button onclick="kirim()" id="btnKirim">KIRIM LAPORAN</button>
    <div id="loading">Mengirim data... Jangan tutup halaman...</div>
  </div>
</div>

<script>
// GANTI URL INI DENGAN URL DEPLOYMENT APPS SCRIPT (Exec)
const API_URL = "https://script.google.com/macros/s/AKfycbwR3teEkRtlaNypd2FQecbLrv6Axx0lTXDDPKiDwyF5YUSpXCet6bUrt_EbKxl1ZCo-Cg/exec"; 

let DATA_SISWA = {}; // Menyimpan data lokal

// Load Data saat web dibuka
window.onload = function() {
  fetch(API_URL, {
    method: "POST",
    body: JSON.stringify({ action: "get_siswa" })
  })
  .then(res => res.json())
  .then(res => {
    if(res.status) {
      DATA_SISWA = res.data;
      const selKelas = document.getElementById('pilihKelas');
      selKelas.innerHTML = '<option value="">-- Pilih Kelas --</option>';
      Object.keys(DATA_SISWA).forEach(k => {
        selKelas.innerHTML += `<option value="${k}">${k}</option>`;
      });
    } else { alert("Gagal mengambil data siswa"); }
  });
};

// Saat Kelas Dipilih -> Munculkan Nama
function loadNama() {
  const k = document.getElementById('pilihKelas').value;
  const selNama = document.getElementById('pilihNama');
  
  if (k && DATA_SISWA[k]) {
    selNama.innerHTML = '<option value="">-- Pilih Nama --</option>';
    DATA_SISWA[k].forEach(s => {
      // Value kita simpan username untuk dikirim ke backend
      selNama.innerHTML += `<option value="${s.user}" data-nama="${s.nama}">${s.nama}</option>`;
    });
    document.getElementById('boxNama').classList.remove('hidden');
    document.getElementById('formIbadah').classList.remove('hidden');
  } else {
    document.getElementById('boxNama').classList.add('hidden');
    document.getElementById('formIbadah').classList.add('hidden');
  }
}

async function kirim() {
  const username = document.getElementById('pilihNama').value;
  const namaOption = document.querySelector('#pilihNama option:checked');
  const nama = namaOption ? namaOption.getAttribute('data-nama') : "";
  const kelas = document.getElementById('pilihKelas').value;
  
  const fotoInp = document.getElementById('fotoInput');
  
  if (!username || !kelas) return alert("Pilih Nama dan Kelas dulu!");
  if (fotoInp.files.length === 0) return alert("Wajib upload foto bukti!");

  document.getElementById('btnKirim').disabled = true;
  document.getElementById('loading').style.display = 'block';

  // 1. Ambil GPS
  let lat = '', long = '';
  try {
    const pos = await new Promise((res, rej) => 
      navigator.geolocation.getCurrentPosition(res, rej, {timeout: 3000})
    );
    lat = pos.coords.latitude; 
    long = pos.coords.longitude;
  } catch(e) { console.log("GPS off"); }

  // 2. Proses Foto
  const reader = new FileReader();
  reader.readAsDataURL(fotoInp.files[0]);
  
  reader.onload = async function() {
    const base64 = reader.result;

    const payload = {
      action: "simpan",
      username: username,
      nama: nama,
      kelas: kelas,
      lat: lat, long: long,
      foto: base64,
      
      // Data Ibadah
      puasa: document.getElementById('puasa').value,
      ket_puasa: document.getElementById('ket_puasa').value,
      shalat: document.getElementById('shalat').value,
      ket_shalat: document.getElementById('ket_shalat').value,
      tarawih: document.getElementById('tarawih').value,
      ket_tarawih: document.getElementById('ket_tarawih').value,
      tadarus: document.getElementById('tadarus').value,
      ket_tadarus: document.getElementById('ket_tadarus').value,
      sedekah: document.getElementById('sedekah').value,
      ket_sedekah: document.getElementById('ket_sedekah').value
    };

    try {
      const req = await fetch(API_URL, { method: "POST", body: JSON.stringify(payload) });
      const res = await req.json();
      if(res.status) {
        alert("âœ… Alhamdulillah, Laporan Terkirim!\nPoin kamu: " + res.poin);
        location.reload();
      } else {
        alert("Gagal mengirim: " + res.message);
        document.getElementById('btnKirim').disabled = false;
      }
    } catch(e) {
      alert("Error Koneksi.");
      document.getElementById('btnKirim').disabled = false;
    }
    document.getElementById('loading').style.display = 'none';
  };
}
</script>

</body>
</html>
