<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>E-RAMADHAN SMKNB 2026</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body{
  font-family:Segoe UI;
  background:linear-gradient(135deg,#0f2027,#203a43,#2c5364);
  color:white;
  text-align:center;
  padding:20px;
}
.card{
  background:white;
  color:#333;
  padding:20px;
  border-radius:15px;
  margin:15px auto;
  max-width:400px;
}
input,select,button{
  width:100%;
  padding:10px;
  margin:8px 0;
}
button{
  background:#203a43;
  color:white;
  border:none;
  cursor:pointer;
}
.preview{
  width:100%;
  border-radius:10px;
  margin-top:10px;
}
</style>
</head>

<body>

<h2>ðŸŒ™ E-RAMADHAN SMKNB 2026</h2>

<!-- LOGIN -->
<div class="card" id="loginBox">
  <h3>Login</h3>
  <input id="u" placeholder="Username">
  <input id="p" type="password" placeholder="Password">
  <button onclick="login()">Login</button>
</div>

<div id="app" style="display:none;">

<!-- FORM -->
<div class="card">
<h3>Laporan Ibadah</h3>

<select id="puasa">
<option>Ya</option>
<option>Tidak</option>
</select>

<select id="shalat">
<option>Lengkap</option>
<option>Tidak Lengkap</option>
</select>

<select id="tarawih">
<option>Ya</option>
<option>Tidak</option>
</select>

<select id="tadarus">
<option>Ya</option>
<option>Tidak</option>
</select>

<select id="sedekah">
<option>Ya</option>
<option>Tidak</option>
</select>

<!-- FOTO SELFIE -->
<input type="file" id="foto" accept="image/*" capture="environment" onchange="previewFoto()">
<img id="preview" class="preview" style="display:none;">

<button onclick="simpan()">Simpan</button>

</div>

<!-- DASHBOARD ADMIN -->
<div class="card" id="dashboard" style="display:none;">
<h3>Ranking</h3>
<canvas id="chart"></canvas>
</div>

</div>

<script>
const API_URL="https://script.google.com/macros/s/AKfycbyeSUsGRILKjV-_VbM4AdGS47Xw_Xc6goo2bhryaS0Crsug3CWpjQvyPW9gy_o1BRgs/exec";
let user={};
let chartInstance=null;

// ================= LOGIN =================
async function login(){
try{
const res=await fetch(API_URL,{
method:"POST",
headers:{"Content-Type":"application/json"},
body:JSON.stringify({
action:"login",
username:u.value,
password:p.value
})
});
if(!res.ok) throw new Error();
const data=await res.json();

if(data.status){
user=data;
loginBox.style.display="none";
app.style.display="block";

if(data.role=="admin"){
dashboard.style.display="block";
loadChart();
}

}else{
alert("Login gagal");
}
}catch{
alert("Server tidak merespon");
}
}

// ================= PREVIEW FOTO =================
function previewFoto(){
const file=document.getElementById("foto").files[0];
if(!file) return;

const reader=new FileReader();
reader.onload=function(e){
preview.src=e.target.result;
preview.style.display="block";
}
reader.readAsDataURL(file);
}

// ================= SIMPAN =================
async function simpan(){
try{

let base64Foto="";
const file=document.getElementById("foto").files[0];

if(file){
base64Foto=await toBase64(file);
}

// Ambil GPS
let lat="",long="";
if(navigator.geolocation){
await new Promise((resolve)=>{
navigator.geolocation.getCurrentPosition(pos=>{
lat=pos.coords.latitude;
long=pos.coords.longitude;
resolve();
},()=>resolve());
});
}

await fetch(API_URL,{
method:"POST",
headers:{"Content-Type":"application/json"},
body:JSON.stringify({
action:"simpan",
username:user.username,
nama:user.nama,
kelas:user.kelas,
puasa:puasa.value,
shalat:shalat.value,
tarawih:tarawih.value,
tadarus:tadarus.value,
sedekah:sedekah.value,
foto:base64Foto,
lat:lat,
long:long
})
});

alert("Berhasil disimpan âœ…");

document.getElementById("foto").value="";
preview.style.display="none";

if(user.role=="admin"){
loadChart();
}

}catch{
alert("Gagal kirim data");
}
}

function toBase64(file){
return new Promise((resolve,reject)=>{
const reader=new FileReader();
reader.readAsDataURL(file);
reader.onload=()=>resolve(reader.result);
reader.onerror=error=>reject(error);
});
}

// ================= RANKING =================
async function loadChart(){
const res=await fetch(API_URL,{
method:"POST",
headers:{"Content-Type":"application/json"},
body:JSON.stringify({action:"ranking"})
});
const data=await res.json();

if(chartInstance){
chartInstance.destroy();
}

chartInstance=new Chart(document.getElementById("chart"),{
type:"bar",
data:{
labels:Object.keys(data),
datasets:[{
label:"Total Poin",
data:Object.values(data)
}]
},
options:{
responsive:true,
plugins:{
legend:{display:false}
}
}
});
}
</script>

</body>
</html>
