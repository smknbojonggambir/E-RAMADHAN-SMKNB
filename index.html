<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>MONITORING RAMADHAN</title>
<style>
  :root { --main: #27ae60; --dark: #2c3e50; --bg: #f4f6f7; }
  body { font-family: sans-serif; background: var(--dark); color: #333; margin: 0; padding: 10px; }
  
  /* Layout */
  .card { background: white; border-radius: 12px; padding: 15px; margin-bottom: 15px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
  .header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #eee; padding-bottom: 10px; margin-bottom: 10px; }
  .btn { padding: 10px; border: none; border-radius: 6px; cursor: pointer; color: white; background: var(--main); font-weight: bold; }
  .btn-danger { background: #c0392b; font-size: 0.8em; }
  
  /* Input & Form */
  input, select, textarea { width: 100%; padding: 10px; margin: 5px 0 10px; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; }
  
  /* SISWA: Accordion */
  .act-item { border: 1px solid #eee; border-radius: 8px; margin-bottom: 5px; overflow: hidden; }
  .act-head { background: #f9f9f9; padding: 12px; cursor: pointer; font-weight: 600; }
  .act-body { display: none; padding: 12px; border-top: 1px solid #eee; }
  .open .act-body { display: block; }
  
  /* ADMIN: Table */
  .table-res { overflow-x: auto; }
  table { width: 100%; border-collapse: collapse; font-size: 0.9em; }
  th, td { padding: 10px; text-align: left; border-bottom: 1px solid #eee; }
  th { background: #f1f1f1; }
  .row-clk { cursor: pointer; transition: 0.2s; }
  .row-clk:hover { background: #e8f6f3; }
  
  /* ADMIN: Detail Modal */
  #modalDetail { position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: none; justify-content: center; align-items: center; z-index: 100; }
  .modal-content { background: white; width: 90%; max-height: 80vh; overflow-y: auto; padding: 20px; border-radius: 10px; }
  .detail-row { margin-bottom: 10px; border-bottom: 1px dashed #ccc; padding-bottom: 5px; }
  
  .hidden { display: none; }
</style>
</head>
<body>

<div id="p-login" class="card">
  <h2 style="text-align:center; color:var(--main);">üåô Login Monitoring</h2>
  <input id="u" placeholder="Username">
  <input id="p" type="password" placeholder="Password">
  <button class="btn" onclick="login()" style="width:100%">MASUK</button>
</div>

<div id="p-siswa" class="hidden">
  <div class="card">
    <div class="header">
      <b id="s-name">Siswa</b>
      <button class="btn btn-danger" onclick="location.reload()">Keluar</button>
    </div>
    <div id="list-act"></div>
    <button class="btn" onclick="kirimLaporan()" style="width:100%; margin-top:10px;">üì§ KIRIM LAPORAN</button>
  </div>
</div>

<div id="p-admin" class="hidden">
  <div class="card">
    <div class="header">
      <b>üë®‚Äçüè´ Dashboard Guru</b>
      <button class="btn btn-danger" onclick="location.reload()">Keluar</button>
    </div>
    
    <div style="display:flex; gap:5px;">
      <select id="adm-filter-kelas" onchange="renderTable()"><option value="All">Semua Kelas</option></select>
      <input type="date" id="adm-filter-date" onchange="renderTable()">
    </div>

    <div class="table-res">
      <table id="adm-table">
        <thead><tr><th>Nama</th><th>Kelas</th><th>Poin</th><th>Aksi</th></tr></thead>
        <tbody id="adm-tbody"></tbody>
      </table>
    </div>
  </div>
</div>

<div id="modalDetail">
  <div class="modal-content">
    <h3>üìù Detail Siswa</h3>
    <div id="detail-content"></div>
    
    <h4 style="margin-bottom:5px;">üí¨ Berikan Catatan/Evaluasi:</h4>
    <textarea id="adm-note-input" rows="3" placeholder="Tulis pesan untuk siswa..."></textarea>
    <button class="btn" onclick="simpanCatatan()" style="width:100%">SIMPAN CATATAN</button>
    <button class="btn btn-danger" onclick="closeModal()" style="width:100%; margin-top:5px; background:#999;">TUTUP</button>
  </div>
</div>

<script>
const API = "https://script.google.com/macros/s/AKfycbyj9jrCTwgARYLpFhaZwn4QoWmvVHqb0dFA_EWT6oRhsGtHEhePxkyMIGvFs693tJE0/exec"; 
let USER = null;
let REKAP_DATA = [];
let ACTIVE_ROW = null; // Untuk admin menyimpan catatan

const ITEMS = ["1. Sahur", "2. Subuh", "3. Olahraga", "4. Keluarga", "5. Dzuhur", "6. Pesantren", "7. Ashar", "8. Sosial", "9. Buka", "10. Magrib", "11. Isya", "12. Tarawih", "13. Tadarus", "14. Tidur"];

// === LOGIN ===
async function login(){
  const u = document.getElementById('u').value, p = document.getElementById('p').value;
  const r = await fetch(API, {method:'POST', body:JSON.stringify({action:'login', u, p})});
  const d = await r.json();
  
  if(d.status){
    USER = d;
    document.getElementById('p-login').classList.add('hidden');
    
    if(d.role === 'Admin'){
      document.getElementById('p-admin').classList.remove('hidden');
      loadAdminData();
    } else {
      document.getElementById('p-siswa').classList.remove('hidden');
      document.getElementById('s-name').innerText = d.nama;
      renderSiswaForm();
    }
  } else { alert(d.message); }
}

// === LOGIC SISWA ===
function renderSiswaForm(){
  const c = document.getElementById('list-act');
  ITEMS.forEach((n, i) => {
    c.innerHTML += `
      <div class="act-item">
        <div class="act-head" onclick="this.nextElementSibling.style.display = this.nextElementSibling.style.display==='block'?'none':'block'">${n}</div>
        <div class="act-body">
          <label>Jam:</label><input type="time" id="t_${i+1}">
          <label>Foto:</label><input type="file" onchange="enc(this, ${i+1})"><br>
          <label>Catatan:</label><input type="text" id="n_${i+1}">
          <input type="hidden" id="img_${i+1}">
        </div>
      </div>`;
  });
}

function enc(inp, id){
  const r = new FileReader();
  r.onload = e => document.getElementById('img_'+id).value = e.target.result;
  r.readAsDataURL(inp.files[0]);
}

async function kirimLaporan(){
  if(!confirm("Kirim?")) return;
  let data = {};
  for(let i=1; i<=14; i++){
    data["item_"+i] = {
      time: document.getElementById('t_'+i).value,
      note: document.getElementById('n_'+i).value,
      img: document.getElementById('img_'+i).value
    };
  }
  await fetch(API, {method:'POST', body:JSON.stringify({
    action:'simpan', u:USER.u, nama:USER.nama, kelas:USER.kelas, gps:'-', data:data
  })});
  alert("Terkirim!"); location.reload();
}

// === LOGIC ADMIN ===
async function loadAdminData(){
  const r = await fetch(API, {method:'POST', body:JSON.stringify({action:'get_rekap'})});
  const res = await r.json();
  REKAP_DATA = res.data;
  
  // Isi Pilihan Kelas
  const kelasUnik = [...new Set(REKAP_DATA.map(x => x.kelas))];
  const sel = document.getElementById('adm-filter-kelas');
  kelasUnik.forEach(k => { sel.innerHTML += `<option value="${k}">${k}</option>`; });
  
  renderTable();
}

function renderTable(){
  const k = document.getElementById('adm-filter-kelas').value;
  const d = document.getElementById('adm-filter-date').value; // yyyy-mm-dd
  const tb = document.getElementById('adm-tbody');
  tb.innerHTML = '';

  REKAP_DATA.forEach(row => {
    // Filter Kelas
    if(k !== 'All' && row.kelas !== k) return;
    
    // Filter Tanggal (Waktu format: dd/MM/yyyy HH:mm)
    if(d) {
      // Ubah dd/MM/yyyy jadi yyyy-mm-dd untuk compare
      const parts = row.waktu.split(' ')[0].split('/');
      const rowDate = `${parts[2]}-${parts[1]}-${parts[0]}`;
      if(rowDate !== d) return;
    }

    tb.innerHTML += `
      <tr class="row-clk">
        <td>${row.nama}</td>
        <td>${row.kelas}</td>
        <td><b>${row.poin}</b></td>
        <td><button class="btn" style="padding:5px; font-size:10px;" onclick="openDetail(${row.row})">Cek</button></td>
      </tr>`;
  });
}

function openDetail(rowIndex){
  const data = REKAP_DATA.find(x => x.row === rowIndex);
  ACTIVE_ROW = rowIndex;
  
  const content = document.getElementById('detail-content');
  content.innerHTML = `<p><b>Waktu Kirim:</b> ${data.waktu}</p><hr>`;
  
  // Data aktivitas ada di array 'detail' index 4 s/d 17 (Kolom E-R)
  // Kolom U (Catatan Guru) ada di index 20
  
  ITEMS.forEach((nama, idx) => {
    const raw = data.detail[idx + 4]; // Geser 4 kolom (A-D)
    if(raw && raw !== "-"){
      const parts = raw.split('|'); // Pisahkan Time | Note | Link
      const time = parts[0] || "";
      const note = parts[1] || "";
      const img = parts[2] && parts[2].includes('http') ? `<a href="${parts[2]}" target="_blank">Lihat Foto</a>` : "Tidak ada foto";
      
      content.innerHTML += `
        <div class="detail-row">
          <b>${nama}</b><br>
          <small>üïí ${time} | üìù ${note}</small><br>
          <small>${img}</small>
        </div>`;
    }
  });

  // Isi kotak input dengan catatan yang sudah ada
  document.getElementById('adm-note-input').value = data.catatan_guru || "";
  
  document.getElementById('modalDetail').style.display = 'flex';
}

function closeModal(){ document.getElementById('modalDetail').style.display = 'none'; }

async function simpanCatatan(){
  const note = document.getElementById('adm-note-input').value;
  const btn = document.querySelector('#modalDetail button');
  btn.innerText = "Menyimpan...";
  
  await fetch(API, {method:'POST', body:JSON.stringify({
    action:'save_note', row:ACTIVE_ROW, note:note
  })});
  
  alert("Catatan tersimpan!");
  closeModal();
  loadAdminData(); // Refresh data
  btn.innerText = "SIMPAN CATATAN";
}
</script>
</body>
</html>
