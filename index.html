<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>E-RAMADHAN SMKNB</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
<style>
  :root { --primary: #065f46; --primary-light: #059669; --accent: #f59e0b; --bg: #f0fdf4; --card: #fff; }
  body { font-family: 'Poppins', sans-serif; background: var(--bg); margin: 0; padding: 0; color: #1f2937; padding-bottom: 50px; }
  
  /* HEADER */
  .header { background: linear-gradient(135deg, var(--primary), var(--primary-light)); color: white; padding: 30px 20px 40px; text-align: center; border-radius: 0 0 30px 30px; box-shadow: 0 4px 20px rgba(6,95,70,0.2); }
  .logo { width: 80px; height: 80px; background: white; border-radius: 50%; padding: 5px; margin-bottom: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); object-fit: contain; }
  
  /* CONTAINER */
  .container { max-width: 500px; margin: -30px auto 0; padding: 0 15px; position: relative; z-index: 2; }
  .card { background: var(--card); padding: 20px; border-radius: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.05); margin-bottom: 15px; animation: fadeUp 0.5s ease-out; }
  
  /* FORM ELEMENTS */
  label { font-weight: 600; font-size: 0.9rem; display: block; margin: 10px 0 5px; color: var(--primary); }
  select, input, button { width: 100%; padding: 12px; border-radius: 10px; border: 1px solid #e5e7eb; margin-bottom: 10px; box-sizing: border-box; font-family: inherit; }
  button { background: var(--primary); color: white; border: none; font-weight: bold; cursor: pointer; box-shadow: 0 4px 10px rgba(6,95,70,0.3); }
  button:disabled { background: #ccc; }
  .act-group { border: 1px solid #f3f4f6; padding: 15px; border-radius: 12px; background: #fff; margin-bottom: 15px; border-left: 4px solid var(--accent); }

  /* ADMIN STYLES */
  .admin-badge { background: #fef3c7; color: #d97706; padding: 2px 8px; border-radius: 4px; font-size: 0.7em; font-weight: bold; }
  .row-data { padding: 12px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; cursor: pointer; transition: 0.2s; }
  .row-data:hover { background: #f9fafb; }
  .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 100; display: none; justify-content: center; align-items: center; padding: 20px; }
  .modal-content { background: white; width: 100%; max-width: 400px; max-height: 80vh; overflow-y: auto; border-radius: 15px; padding: 20px; position: relative; }
  
  .hidden { display: none; }
  @keyframes fadeUp { from { opacity:0; transform:translateY(20px); } to { opacity:1; transform:translateY(0); } }
</style>
</head>
<body>

<div class="header">
  <img src="https://raw.githubusercontent.com/smknbojonggambir/E-RAMADHAN-SMKNB/main/LOGO.png" class="logo">
  <h2 style="margin:0;">E-RAMADHAN SMKNB</h2>
  <p style="margin:5px 0 0; font-size:0.9rem; opacity:0.9;">Laporan Ibadah & Monitoring Guru</p>
</div>

<div class="container">
  
  <div id="panel-siswa">
    <div class="card">
      <h3 style="text-align:center; color:var(--primary); margin-top:0;">üìã Form Siswa</h3>
      <label>Kelas</label><select id="pKelas" onchange="loadNama()"><option>Loading...</option></select>
      <div id="areaNama" class="hidden">
        <label>Nama Siswa</label><select id="pNama"><option>Pilih Nama</option></select>
        <button onclick="bukaForm()" style="margin-top:10px;">MULAI ISI LAPORAN</button>
      </div>
    </div>

    <div id="formIbadah" class="hidden">
      <div class="card">
        <div class="act-group"><b>1. Puasa?</b><select id="puasa"><option value="Ya">‚úÖ Ya Full</option><option value="Setengah">üåó Setengah</option><option value="Tidak">‚ùå Tidak</option></select><input id="k_puasa" placeholder="Ket..."></div>
        <div class="act-group"><b>2. Shalat Wajib?</b><select id="shalat"><option value="Ya">‚úÖ Lengkap</option><option value="Bolong">‚ö†Ô∏è Bolong</option><option value="Tidak">‚ùå Tidak</option></select><input id="k_shalat" placeholder="Ket..."></div>
        <div class="act-group"><b>3. Tarawih?</b><select id="tarawih"><option value="Ya">‚úÖ Ya</option><option value="Tidak">‚ùå Tidak</option></select><input id="k_tarawih" placeholder="Ket..."></div>
        <div class="act-group"><b>4. Tadarus?</b><select id="tadarus"><option value="Ya">‚úÖ Ya</option><option value="Tidak">‚ùå Tidak</option></select><input id="k_tadarus" placeholder="Ket..."></div>
        <div class="act-group"><b>5. Sedekah?</b><select id="sedekah"><option value="Ya">‚úÖ Ya</option><option value="Tidak">‚ùå Tidak</option></select><input id="k_sedekah" placeholder="Ket..."></div>
        <div class="act-group"><b>üì∏ Foto Bukti</b><input type="file" id="foto" accept="image/*" capture="environment"></div>
        <button onclick="kirim()" id="btnKirim">üöÄ KIRIM LAPORAN</button>
      </div>
    </div>
  </div>

  <div id="panel-login-admin" class="hidden">
    <div class="card" style="text-align:center;">
      <h3>üîê Login Guru</h3>
      <input type="password" id="adminPass" placeholder="Masukkan Password Guru">
      <button onclick="loginAdmin()">MASUK</button>
      <button onclick="modeSiswa()" style="background:#ddd; color:#333; margin-top:5px;">Kembali ke Siswa</button>
    </div>
  </div>

  <div id="dashboard-admin" class="hidden">
    <div class="card">
      <div style="display:flex; justify-content:space-between; align-items:center;">
        <h3 style="margin:0;">üë®‚Äçüè´ Dashboard</h3>
        <button onclick="location.reload()" style="width:auto; padding:5px 10px; font-size:0.8rem; background:#ef4444;">Logout</button>
      </div>
      <hr>
      <label>Tanggal Laporan:</label>
      <input type="date" id="admDate" onchange="loadRekap()">
      <label>Filter Kelas:</label>
      <select id="admKelas" onchange="loadRekap()">
        <option value="Semua">Semua Kelas</option>
      </select>
      <div style="background:#e0f2f1; padding:10px; border-radius:8px; font-size:0.9rem; margin-bottom:10px;">
        Total Lapor: <b id="totalLapor">0</b> Siswa
      </div>
    </div>

    <div class="card" style="padding:0;">
      <div id="list-rekap">
        <div style="padding:20px; text-align:center; color:#999;">Pilih Tanggal untuk melihat data.</div>
      </div>
    </div>
  </div>

  <div style="text-align:center; margin-top:30px;">
    <span onclick="modeAdmin()" style="font-size:0.8rem; color:#ccc; cursor:pointer;">Login Guru / Admin</span>
  </div>

</div>

<div id="modalDetail" class="modal">
  <div class="modal-content">
    <h3 id="mNama" style="margin-top:0; color:var(--primary);">Nama Siswa</h3>
    <p id="mKelas" style="color:#666; margin-bottom:15px;"></p>
    <div id="mBody"></div>
    <div style="margin-top:15px; text-align:right;">
      <a id="mFoto" href="#" target="_blank" style="text-decoration:none; color:white; background:#f59e0b; padding:8px 15px; border-radius:20px; font-size:0.9rem;">üì∏ Lihat Foto</a>
      <button onclick="document.getElementById('modalDetail').style.display='none'" style="width:auto; margin-left:10px; background:#ddd; color:#333;">Tutup</button>
    </div>
  </div>
</div>

<script>
// ==========================================
// PASTE URL DEPLOYMENT DISINI
// ==========================================
const API = "URL_WEB_APP_ANDA_DISINI"; 

let DATA_SISWA = {};

// === INIT ===
window.onload = function() {
  // Set tanggal hari ini default untuk admin
  document.getElementById('admDate').valueAsDate = new Date();
  
  // Load Data Siswa
  fetch(API, {method: "POST", body: JSON.stringify({action: "get_siswa"})})
  .then(r=>r.json()).then(res => {
    if(res.status) {
      DATA_SISWA = res.data;
      const s = document.getElementById('pKelas');
      const sAdm = document.getElementById('admKelas');
      s.innerHTML = '<option value="">-- Pilih Kelas --</option>';
      Object.keys(DATA_SISWA).sort().forEach(k => {
        s.innerHTML += `<option value="${k}">${k}</option>`;
        sAdm.innerHTML += `<option value="${k}">${k}</option>`;
      });
    }
  });
}

// === MODE SWITCHING ===
function modeAdmin() {
  document.getElementById('panel-siswa').classList.add('hidden');
  document.getElementById('panel-login-admin').classList.remove('hidden');
}
function modeSiswa() {
  document.getElementById('panel-login-admin').classList.add('hidden');
  document.getElementById('panel-siswa').classList.remove('hidden');
}

// === SISWA LOGIC ===
function loadNama() {
  const k = document.getElementById('pKelas').value;
  const n = document.getElementById('pNama');
  if(k && DATA_SISWA[k]) {
    n.innerHTML = '<option>-- Pilih Nama --</option>';
    DATA_SISWA[k].sort((a,b)=>a.nama.localeCompare(b.nama)).forEach(x => {
      n.innerHTML += `<option value="${x.user}" data-n="${x.nama}">${x.nama}</option>`;
    });
    document.getElementById('areaNama').classList.remove('hidden');
  }
}
function bukaForm(){ document.getElementById('formIbadah').classList.remove('hidden'); }

async function kirim() {
  const f = document.getElementById('foto');
  if(f.files.length === 0) return alert("Wajib foto!");
  if(!confirm("Kirim Laporan?")) return;
  
  const btn = document.getElementById('btnKirim');
  btn.innerText = "Mengirim..."; btn.disabled = true;

  let lat='-', long='-';
  try { const pos = await new Promise((r,j)=>navigator.geolocation.getCurrentPosition(r,j,{timeout:3000})); lat=pos.coords.latitude; long=pos.coords.longitude; } catch(e){}

  const r = new FileReader();
  r.readAsDataURL(f.files[0]);
  r.onload = async function() {
    const d = {
      action:'simpan',
      username: document.getElementById('pNama').value,
      nama: document.querySelector('#pNama option:checked').getAttribute('data-n'),
      kelas: document.getElementById('pKelas').value,
      foto: r.result, lat, long,
      puasa: document.getElementById('puasa').value, ket_puasa: document.getElementById('k_puasa').value,
      shalat: document.getElementById('shalat').value, ket_shalat: document.getElementById('k_shalat').value,
      tarawih: document.getElementById('tarawih').value, ket_tarawih: document.getElementById('k_tarawih').value,
      tadarus: document.getElementById('tadarus').value, ket_tadarus: document.getElementById('k_tadarus').value,
      sedekah: document.getElementById('sedekah').value, ket_sedekah: document.getElementById('k_sedekah').value,
    };
    const req = await fetch(API, {method:'POST', body:JSON.stringify(d)});
    const res = await req.json();
    if(res.status) { alert("Berhasil! Poin: "+res.poin); location.reload(); }
    else { alert("Gagal"); btn.disabled=false; btn.innerText="Kirim Ulang"; }
  }
}

// === ADMIN LOGIC ===
async function loginAdmin() {
  const p = document.getElementById('adminPass').value;
  const btn = document.querySelector('#panel-login-admin button');
  btn.innerText = "Cek...";
  const r = await fetch(API, {method:'POST', body:JSON.stringify({action:'login_admin', pass:p})});
  const res = await r.json();
  
  if(res.status) {
    document.getElementById('panel-login-admin').classList.add('hidden');
    document.getElementById('dashboard-admin').classList.remove('hidden');
    loadRekap();
  } else {
    alert("Password Salah!");
    btn.innerText = "MASUK";
  }
}

async function loadRekap() {
  const tgl = document.getElementById('admDate').value;
  const kls = document.getElementById('admKelas').value;
  const list = document.getElementById('list-rekap');
  list.innerHTML = '<p style="text-align:center; padding:20px;">Memuat data...</p>';
  
  const r = await fetch(API, {method:'POST', body:JSON.stringify({action:'get_rekap', tanggal:tgl, kelas:kls})});
  const res = await r.json();
  
  list.innerHTML = '';
  document.getElementById('totalLapor').innerText = res.data.length;
  
  if(res.data.length === 0) {
    list.innerHTML = '<p style="text-align:center; padding:20px;">Belum ada laporan masuk.</p>';
    return;
  }

  res.data.forEach(d => {
    const raw = JSON.stringify(d.detail).replace(/"/g, '&quot;');
    list.innerHTML += `
      <div class="row-data" onclick="bukaDetail('${raw}')">
        <div>
          <div style="font-weight:bold;">${d.nama}</div>
          <div style="font-size:0.8rem; color:#666;">${d.kelas} | ${d.waktu.split(' ')[1]}</div>
        </div>
        <div style="text-align:right;">
          <div style="color:var(--primary); font-weight:bold;">${d.poin} Poin</div>
          <div style="font-size:0.7rem;">${d.foto.length > 5 ? 'üì∏ Ada Foto' : '‚ùå No Foto'}</div>
        </div>
      </div>
    `;
  });
}

function bukaDetail(jsonStr) {
  const d = JSON.parse(jsonStr); 
  // d adalah array: [Tanggal, User, Nama, Kelas, Puasa, KetP, Shalat, KetS, Tarawih, KetT, Tadarus, KetTd, Sedekah, KetSd, Foto, Lat, Long, Poin]
  // Index: 0=Tgl, 2=Nama, 3=Kelas, 4=Puasa, 6=Shalat, 8=Tarawih, 10=Tadarus, 12=Sedekah, 14=Foto
  
  document.getElementById('mNama').innerText = d[2];
  document.getElementById('mKelas').innerText = d[3];
  
  let html = `
    <b>Puasa:</b> ${d[4]} <br><i>"${d[5]||'-'}"</i><hr style="margin:5px 0">
    <b>Shalat:</b> ${d[6]} <br><i>"${d[7]||'-'}"</i><hr style="margin:5px 0">
    <b>Tarawih:</b> ${d[8]} <br><i>"${d[9]||'-'}"</i><hr style="margin:5px 0">
    <b>Tadarus:</b> ${d[10]} <br><i>"${d[11]||'-'}"</i><hr style="margin:5px 0">
    <b>Sedekah:</b> ${d[12]} <br><i>"${d[13]||'-'}"</i>
  `;
  document.getElementById('mBody').innerHTML = html;
  
  const btnFoto = document.getElementById('mFoto');
  if(d[14] && d[14].length > 5) {
    btnFoto.href = d[14];
    btnFoto.style.display = 'inline-block';
  } else {
    btnFoto.style.display = 'none';
  }
  
  document.getElementById('modalDetail').style.display = 'flex';
}
</script>
</body>
</html>
